<!DOCTYPE html><html lang="en"><head><title>002-hash/sha1</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="002-hash/sha1"><meta name="groc-project-path" content="js/src/002-hash/sha1.js"><meta name="groc-github-url" content="https://github.com/aureooms/js-hash"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/aureooms/js-hash/blob/master/js/src/002-hash/sha1.js">js/src/002-hash/sha1.js</a></div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments "><div class="wrapper"><p>SHA1</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> sha1 = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(bytes, n, digest)</span> {</span>

	<span class="hljs-keyword">var</span> q, z, u, last, h, m, y, o, j, tail, zeroes;

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cycle</span> <span class="hljs-params">(h, w)</span> {</span>

		<span class="hljs-keyword">var</span> j, f, k, a, b, c, d, e, t;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>initialize hash value for this chunk:</p></div></div><div class="code"><div class="wrapper">		a = h[<span class="hljs-number">0</span>];
		b = h[<span class="hljs-number">1</span>];
		c = h[<span class="hljs-number">2</span>];
		d = h[<span class="hljs-number">3</span>];
		e = h[<span class="hljs-number">4</span>];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Main loop:[35]
for j from 0 to 79</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">80</span>; ++j) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if 0 ≤ j ≤ 19 then</p></div></div><div class="code"><div class="wrapper">			<span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> &lt;= j &amp;&amp; j &lt;= <span class="hljs-number">19</span>){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>f = (b and c) or ((not b) and d)</p></div></div><div class="code"><div class="wrapper">				f = (b &amp; c) | ((~ b) &amp; d);
				k = <span class="hljs-number">0x5A827999</span>;
			}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>else if 20 ≤ j ≤ 39</p></div></div><div class="code"><div class="wrapper">			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">20</span> &lt;= j &amp;&amp; j &lt;= <span class="hljs-number">39</span>){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>f = b xor c xor d</p></div></div><div class="code"><div class="wrapper">				f = b ^ c ^ d;
				k = <span class="hljs-number">0x6ED9EBA1</span>;
			}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>else if 40 ≤ j ≤ 59</p></div></div><div class="code"><div class="wrapper">			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">40</span> &lt;= j &amp;&amp; j &lt;= <span class="hljs-number">59</span>){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>f = (b and c) or (b and d) or (c and d)</p></div></div><div class="code"><div class="wrapper">				f = (b &amp; c) | (b &amp; d) | (c &amp; d);
				k = <span class="hljs-number">0x8F1BBCDC</span>;
			}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>else if 60 ≤ j ≤ 79</p></div></div><div class="code"><div class="wrapper">			<span class="hljs-keyword">else</span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>f = b xor c xor d</p></div></div><div class="code"><div class="wrapper">				f = b ^ c ^ d;
				k = <span class="hljs-number">0xCA62C1D6</span>;
			}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>t = (a leftrotate 5) + f + e + k + w[j]</p></div></div><div class="code"><div class="wrapper">			t = add32(add32(rot32(a, <span class="hljs-number">5</span>), f), add32(add32(e, k), w[j]));
			e = d;
			d = c;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>c = b leftrotate 30</p></div></div><div class="code"><div class="wrapper">			c = rot32(b, <span class="hljs-number">30</span>);
			b = a;
			a = t;
		}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add this chunk&#39;s hash to result so far:</p></div></div><div class="code"><div class="wrapper">		h[<span class="hljs-number">0</span>] = add32(h[<span class="hljs-number">0</span>], a);
		h[<span class="hljs-number">1</span>] = add32(h[<span class="hljs-number">1</span>], b);
		h[<span class="hljs-number">2</span>] = add32(h[<span class="hljs-number">2</span>], c);
		h[<span class="hljs-number">3</span>] = add32(h[<span class="hljs-number">3</span>], d);
		h[<span class="hljs-number">4</span>] = add32(h[<span class="hljs-number">4</span>], e);
	}

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">call</span> <span class="hljs-params">(h, data, o)</span> {</span>

		<span class="hljs-keyword">var</span> w, j, k;


		w = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">80</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>break chunk into sixteen 32-bit big-endian words w[i], 0 ≤ i ≤ 15</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">16</span>; ++j) {
			w[j] = big32(data, o + j * <span class="hljs-number">4</span>);
		}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Extend the sixteen 32-bit words into eighty 32-bit words:
for j from 16 to 79</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">for</span>(j = <span class="hljs-number">16</span>; j &lt; <span class="hljs-number">80</span>; ++j){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>w[j] = (w[j-3] xor w[j-8] xor w[j-14] xor w[j-16]) leftrotate 1</p></div></div><div class="code"><div class="wrapper">			k = (w[j-<span class="hljs-number">3</span>] ^ w[j-<span class="hljs-number">8</span>] ^ w[j-<span class="hljs-number">14</span>] ^ w[j-<span class="hljs-number">16</span>]);
			w[j] = rot32(k, <span class="hljs-number">1</span>);
		}


		cycle(h, w);
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>PREPARE</p></div></div><div class="code"><div class="wrapper">	q = n / <span class="hljs-number">8</span> | <span class="hljs-number">0</span>;
	z = q * <span class="hljs-number">8</span>;
	u = n - z;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>append the bit &#39;1&#39; to the message</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">if</span> (u &gt; <span class="hljs-number">0</span>) {
		last = bytes[q] &amp; (~<span class="hljs-number">0</span>) &lt;&lt; (<span class="hljs-number">7</span>-u);
	}
	<span class="hljs-keyword">else</span> {
		last = <span class="hljs-number">0x80</span>;
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Note 1: All variables are unsigned 32 bits and wrap modulo 2^32 when calculating
Note 2: All constants in this pseudo code are in big endian.
Within each word, the most significant byte is stored in the leftmost byte position</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Initialize state:</p></div></div><div class="code"><div class="wrapper">	h = [<span class="hljs-number">0x67452301</span>, <span class="hljs-number">0xEFCDAB89</span>, <span class="hljs-number">0x98BADCFE</span>, <span class="hljs-number">0x10325476</span>, <span class="hljs-number">0xC3D2E1F0</span>];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Process the message in successive 512-bit chunks:
break message into 512-bit chunks</p></div></div><div class="code"><div class="wrapper">	m = n / <span class="hljs-number">512</span> | <span class="hljs-number">0</span>;
	y = (n - <span class="hljs-number">512</span> * m) / <span class="hljs-number">8</span> | <span class="hljs-number">0</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>offset in data</p></div></div><div class="code"><div class="wrapper">	o = <span class="hljs-number">0</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>for each chunk</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; m; ++j, o += <span class="hljs-number">64</span>) {
		call(h, bytes, o);
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>last bytes + padding + length</p></div></div><div class="code"><div class="wrapper">	tail = [];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>last bytes</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; y; ++j) {
		tail.push(bytes[o + j]);
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>special care taken for the very last byte which could
have been modified if n is not a multiple of 8</p></div></div><div class="code"><div class="wrapper">	tail.push(last);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>append 0 ≤ k &lt; 512 bits &#39;0&#39;, so that the resulting
message length (in bits) is congruent to 448 (mod 512)</p></div></div><div class="code"><div class="wrapper">	zeroes = (<span class="hljs-number">448</span> - (n + <span class="hljs-number">1</span>) % <span class="hljs-number">512</span>) / <span class="hljs-number">8</span> | <span class="hljs-number">0</span>;

	<span class="hljs-keyword">if</span> (zeroes &lt; <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>we need an additional block as there is
not enough space left to append
the length of the data in bits</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; -zeroes; ++j) {
			tail.push(<span class="hljs-number">0</span>);
		}

		call(h, tail, <span class="hljs-number">0</span>);

		zeroes = <span class="hljs-number">448</span> / <span class="hljs-number">8</span>;
		tail = [];
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>pad with zeroes</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; zeroes; ++j) {
		tail.push(<span class="hljs-number">0</span>);
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>append length of message (before preparation), in bits,
as 64-bit big-endian integer</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>JavaScript works with 32 bit integers.
tail.push((n &gt;&gt;&gt; 56) &amp; 0xFF);
tail.push((n &gt;&gt;&gt; 48) &amp; 0xFF);
tail.push((n &gt;&gt;&gt; 40) &amp; 0xFF);
tail.push((n &gt;&gt;&gt; 32) &amp; 0xFF);</p></div></div><div class="code"><div class="wrapper">	tail.push(<span class="hljs-number">0</span>);
	tail.push(<span class="hljs-number">0</span>);
	tail.push(<span class="hljs-number">0</span>);
	tail.push(<span class="hljs-number">0</span>);

	tail.push((n &gt;&gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>);
	tail.push((n &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>);
	tail.push((n &gt;&gt;&gt;  <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>);
	tail.push((n &gt;&gt;&gt;  <span class="hljs-number">0</span>) &amp; <span class="hljs-number">0xFF</span>);

	call(h, tail, <span class="hljs-number">0</span>);

	digest[<span class="hljs-number">0</span>]  = (h[<span class="hljs-number">0</span>] &gt;&gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">1</span>]  = (h[<span class="hljs-number">0</span>] &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">2</span>]  = (h[<span class="hljs-number">0</span>] &gt;&gt;&gt;  <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">3</span>]  = (h[<span class="hljs-number">0</span>] &gt;&gt;&gt;  <span class="hljs-number">0</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">4</span>]  = (h[<span class="hljs-number">1</span>] &gt;&gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">5</span>]  = (h[<span class="hljs-number">1</span>] &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">6</span>]  = (h[<span class="hljs-number">1</span>] &gt;&gt;&gt;  <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">7</span>]  = (h[<span class="hljs-number">1</span>] &gt;&gt;&gt;  <span class="hljs-number">0</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">8</span>]  = (h[<span class="hljs-number">2</span>] &gt;&gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">9</span>]  = (h[<span class="hljs-number">2</span>] &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">10</span>] = (h[<span class="hljs-number">2</span>] &gt;&gt;&gt;  <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">11</span>] = (h[<span class="hljs-number">2</span>] &gt;&gt;&gt;  <span class="hljs-number">0</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">12</span>] = (h[<span class="hljs-number">3</span>] &gt;&gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">13</span>] = (h[<span class="hljs-number">3</span>] &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">14</span>] = (h[<span class="hljs-number">3</span>] &gt;&gt;&gt;  <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">15</span>] = (h[<span class="hljs-number">3</span>] &gt;&gt;&gt;  <span class="hljs-number">0</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">16</span>] = (h[<span class="hljs-number">4</span>] &gt;&gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">17</span>] = (h[<span class="hljs-number">4</span>] &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">18</span>] = (h[<span class="hljs-number">4</span>] &gt;&gt;&gt;  <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;
	digest[<span class="hljs-number">19</span>] = (h[<span class="hljs-number">4</span>] &gt;&gt;&gt;  <span class="hljs-number">0</span>) &amp; <span class="hljs-number">0xFF</span>;

	<span class="hljs-keyword">return</span> digest;
};

exports.sha1 = sha1;</div></div></div></div></body></html>